{"version":3,"sources":["file:///D:/course/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BB%83%E4%B9%A0/2048/2048/assets/sprits/Chessboard.ts"],"names":["_decorator","Component","instantiate","Layout","Prefab","tween","UITransform","Vec3","Grid","ccclass","property","SwipeDirection","Chessboard","gridData","values","gridWidth","gridHeight","isSwipeEnabled","onLoad","initChessboard","node","on","handleSwipe","Array","rowCount","i","colCount","fill","ChessboardSize","getComponent","ChessboardWidth","width","ChessboardHeight","height","GridWidth","gap","GridHeight","MakeGrids","spawnRandomGrid","layout","updateLayout","removeAllChildren","j","x","y","gridNode","gridPrefab","setPosition","addChild","gridComp","setSize","setValue","setSwipeEnable","enabled","console","log","direction","directionText","Up","Down","Left","Right","None","result","moved","moves","moveUp","moveDown","moveLeft","moveRight","playMovesAnimation","CheckGameOver","emit","has2048","checkHas2048","originalRow","originalValue","k","mergedResult","push","fromRow","fromCol","toRow","toCol","value","merged","resultValue","originalCol","animate","emptyGrids","length","row","col","Math","floor","random","Promise","resolve","updateGridViews","tweens","m","srcGrid","completed","total","srcX","srcY","tgtX","tgtY","tempNode","tw","to","position","easing","call","targetGrid","playMergeAnimation","removeFromParent","start","targetX","targetY","update","deltaTime"],"mappings":"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","sourcesContent":["// /*\r\n//     0.02版说明：有三种动画\r\n\r\n// */\r\n\r\n\r\n\r\n\r\nimport { _decorator, Component, instantiate, Layout, Node, Prefab, tween, UITransform, Vec3 } from 'cc';\r\nimport { Grid } from './Grid';\r\nimport { Swipe } from './Swipe';\r\nimport { Score } from './Score';\r\nconst { ccclass, property } = _decorator;\r\n\r\nenum SwipeDirection {\r\n    Up,\r\n    Down,\r\n    Left,\r\n    Right,\r\n    None\r\n}\r\n\r\n// 定义移动项（用于播放平移动画）\r\ntype Move = {\r\n    fromRow: number,\r\n    fromCol: number,\r\n    toRow: number,\r\n    toCol: number,\r\n    value: number,          // 原始值（被移动的方块原先的值）\r\n    merged: boolean,        // 是否为合并移动（会把该 tile 移到目标并合并）\r\n    resultValue?: number    // 合并后的值（只有 merged=true 时有）\r\n};\r\n\r\n@ccclass('Chessboard')\r\nexport class Chessboard extends Component {\r\n    @property(Prefab)\r\n    gridPrefab: Prefab = null;\r\n\r\n    @property\r\n    rowCount: number = 4;\r\n    @property\r\n    colCount: number = 4;\r\n\r\n    @property\r\n    gap: number = 10;\r\n\r\n    private gridData: (Grid | null)[][] = [];\r\n    private values: number[][] = [];\r\n    private gridWidth: number = 0;\r\n    private gridHeight: number = 0;\r\n    private isSwipeEnabled: boolean = false;\r\n\r\n    protected onLoad(): void {\r\n        this.initChessboard();\r\n        this.node.on('swipe', this.handleSwipe, this);\r\n    }\r\n\r\n    public initChessboard() {\r\n        this.gridData = new Array(this.rowCount);\r\n        for (let i = 0; i < this.rowCount; i++) {\r\n            this.gridData[i] = new Array(this.colCount).fill(null);\r\n        }\r\n\r\n        this.values = new Array(this.rowCount);\r\n        for (let i = 0; i < this.rowCount; i++) {\r\n            this.values[i] = new Array(this.colCount).fill(0);\r\n        }\r\n\r\n        const ChessboardSize = this.node.getComponent(UITransform);\r\n        const ChessboardWidth = ChessboardSize.width;\r\n        const ChessboardHeight = ChessboardSize.height;\r\n\r\n        const GridWidth = (ChessboardWidth - (this.colCount - 1) * this.gap) / this.colCount;\r\n        const GridHeight = (ChessboardHeight - (this.rowCount - 1) * this.gap) / this.rowCount;\r\n        this.gridWidth = GridWidth;\r\n        this.gridHeight = GridHeight;\r\n\r\n        this.MakeGrids();\r\n\r\n        // 初始两个随机格子（显示生成动画）\r\n        this.spawnRandomGrid(true);\r\n        this.spawnRandomGrid(true);\r\n\r\n        const layout = this.node.getComponent(Layout);\r\n        if (layout) layout.updateLayout();\r\n    }\r\n\r\n    private MakeGrids() {\r\n        this.node.removeAllChildren();\r\n\r\n        for (let i = 0; i < this.rowCount; i++) {\r\n            for (let j = 0; j < this.colCount; j++) {\r\n                const x = j * (this.gridWidth + this.gap) - (this.colCount - 1) * (this.gridWidth + this.gap) / 2;\r\n                const y = -i * (this.gridHeight + this.gap) + (this.rowCount - 1) * (this.gridHeight + this.gap) / 2;\r\n                const gridNode = instantiate(this.gridPrefab);\r\n                gridNode.setPosition(x, y);\r\n                this.node.addChild(gridNode);\r\n\r\n                const gridComp = gridNode.getComponent(Grid);\r\n                if (gridComp) {\r\n                    gridComp.setSize(this.gridWidth, this.gridHeight);\r\n                    gridComp.setValue(0);\r\n                    this.gridData[i][j] = gridComp;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public setSwipeEnable(enabled: boolean) {\r\n        this.isSwipeEnabled = enabled;\r\n        console.log(`滑动功能${enabled ? '启用' : '禁用'}`);\r\n    }\r\n\r\n    private async handleSwipe(direction: SwipeDirection) {\r\n        if (!this.isSwipeEnabled) return;\r\n        const directionText = {\r\n            [SwipeDirection.Up]: \"上\",\r\n            [SwipeDirection.Down]: \"下\",\r\n            [SwipeDirection.Left]: \"左\",\r\n            [SwipeDirection.Right]: \"右\",\r\n            [SwipeDirection.None]: \"无\"\r\n        };\r\n        if (direction === SwipeDirection.None) return;\r\n\r\n        console.log(`开始处理${directionText[direction]}向移动`);\r\n        let result: { moved: boolean, moves: Move[] } = { moved: false, moves: [] };\r\n\r\n        switch (direction) {\r\n            case SwipeDirection.Up: result = this.moveUp(); break;\r\n            case SwipeDirection.Down: result = this.moveDown(); break;\r\n            case SwipeDirection.Left: result = this.moveLeft(); break;\r\n            case SwipeDirection.Right: result = this.moveRight(); break;\r\n        }\r\n\r\n        if (result.moved) {\r\n            // 播放平移动画（等待完成），然后生成新格子并检查游戏结束\r\n            await this.playMovesAnimation(result.moves);\r\n            // 生成随机格子（带生成动画）\r\n            this.spawnRandomGrid(true);\r\n\r\n            if (this.CheckGameOver()) {\r\n                this.node.emit('game-over', { has2048: this.checkHas2048() });\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * moveX 返回移动结果和用于动画的 moves 列表\r\n     * 每个 move 表示一个 tile 从 (fromRow,fromCol) 平移到 (toRow,toCol)\r\n     * merged=true 表示这个移动最终导致合并，resultValue 为合并后的值\r\n     */\r\n\r\n    private moveUp(): { moved: boolean, moves: Move[] } {\r\n        let moved = false;\r\n        const moves: Move[] = [];\r\n\r\n        for (let j = 0; j < this.colCount; j++) {\r\n            for (let i = 1; i < this.rowCount; i++) {\r\n                if (this.values[i][j] !== 0) {\r\n                    const originalRow = i;\r\n                    const originalValue = this.values[i][j];\r\n\r\n                    let k = i;\r\n                    while (k > 0 && this.values[k - 1][j] === 0) {\r\n                        this.values[k - 1][j] = this.values[k][j];\r\n                        this.values[k][j] = 0;\r\n                        k--; moved = true;\r\n                    }\r\n\r\n                    // 如果可以合并\r\n                    if (k > 0 && this.values[k - 1][j] === this.values[k][j]) {\r\n                        const mergedResult = this.values[k - 1][j] * 2;\r\n                        // 记录被移动格子的来源和目标（合并）\r\n                        moves.push({\r\n                            fromRow: originalRow,\r\n                            fromCol: j,\r\n                            toRow: k - 1,\r\n                            toCol: j,\r\n                            value: originalValue,\r\n                            merged: true,\r\n                            resultValue: mergedResult\r\n                        });\r\n\r\n                        this.values[k - 1][j] = mergedResult;\r\n                        this.values[k][j] = 0;\r\n                        moved = true;\r\n                        this.node.emit('score', this.values[k - 1][j]);\r\n                    } else {\r\n                        // 如果没有合并但发生了移动（或即使没移动，也需要记录当原位置 != 最终位置）\r\n                        if (k !== originalRow) {\r\n                            moves.push({\r\n                                fromRow: originalRow,\r\n                                fromCol: j,\r\n                                toRow: k,\r\n                                toCol: j,\r\n                                value: originalValue,\r\n                                merged: false\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // 更新界面数据（但是我们不会立刻覆盖格子显示，动画期间会控制显示）\r\n        // 注意：不要在这里调用 updateGridViews，否则会立即把值写回 UI（我们要等动画）\r\n        return { moved, moves };\r\n    }\r\n\r\n    private moveDown(): { moved: boolean, moves: Move[] } {\r\n        let moved = false;\r\n        const moves: Move[] = [];\r\n        for (let j = 0; j < this.colCount; j++) {\r\n            for (let i = this.rowCount - 2; i >= 0; i--) {\r\n                if (this.values[i][j] !== 0) {\r\n                    const originalRow = i;\r\n                    const originalValue = this.values[i][j];\r\n\r\n                    let k = i;\r\n                    while (k + 1 < this.rowCount && this.values[k + 1][j] === 0) {\r\n                        this.values[k + 1][j] = this.values[k][j];\r\n                        this.values[k][j] = 0;\r\n                        k++; moved = true;\r\n                    }\r\n                    if (k + 1 < this.rowCount && this.values[k + 1][j] === this.values[k][j]) {\r\n                        const mergedResult = this.values[k + 1][j] * 2;\r\n                        moves.push({\r\n                            fromRow: originalRow,\r\n                            fromCol: j,\r\n                            toRow: k + 1,\r\n                            toCol: j,\r\n                            value: originalValue,\r\n                            merged: true,\r\n                            resultValue: mergedResult\r\n                        });\r\n\r\n                        this.values[k + 1][j] = mergedResult;\r\n                        this.values[k][j] = 0;\r\n                        moved = true;\r\n                        this.node.emit('score', this.values[k + 1][j]);\r\n                    } else {\r\n                        if (k !== originalRow) {\r\n                            moves.push({\r\n                                fromRow: originalRow,\r\n                                fromCol: j,\r\n                                toRow: k,\r\n                                toCol: j,\r\n                                value: originalValue,\r\n                                merged: false\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return { moved, moves };\r\n    }\r\n\r\n    private moveLeft(): { moved: boolean, moves: Move[] } {\r\n        let moved = false;\r\n        const moves: Move[] = [];\r\n        for (let i = 0; i < this.rowCount; i++) {\r\n            for (let j = 1; j < this.colCount; j++) {\r\n                if (this.values[i][j] !== 0) {\r\n                    const originalCol = j;\r\n                    const originalValue = this.values[i][j];\r\n\r\n                    let k = j;\r\n                    while (k > 0 && this.values[i][k - 1] === 0) {\r\n                        this.values[i][k - 1] = this.values[i][k];\r\n                        this.values[i][k] = 0;\r\n                        k--; moved = true;\r\n                    }\r\n                    if (k > 0 && this.values[i][k - 1] === this.values[i][k]) {\r\n                        const mergedResult = this.values[i][k - 1] * 2;\r\n                        moves.push({\r\n                            fromRow: i,\r\n                            fromCol: originalCol,\r\n                            toRow: i,\r\n                            toCol: k - 1,\r\n                            value: originalValue,\r\n                            merged: true,\r\n                            resultValue: mergedResult\r\n                        });\r\n\r\n                        this.values[i][k - 1] = mergedResult;\r\n                        this.values[i][k] = 0;\r\n                        moved = true;\r\n                        this.node.emit('score', this.values[i][k - 1]);\r\n                    } else {\r\n                        if (k !== originalCol) {\r\n                            moves.push({\r\n                                fromRow: i,\r\n                                fromCol: originalCol,\r\n                                toRow: i,\r\n                                toCol: k,\r\n                                value: originalValue,\r\n                                merged: false\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return { moved, moves };\r\n    }\r\n\r\n    private moveRight(): { moved: boolean, moves: Move[] } {\r\n        let moved = false;\r\n        const moves: Move[] = [];\r\n        for (let i = 0; i < this.rowCount; i++) {\r\n            for (let j = this.colCount - 2; j >= 0; j--) {\r\n                if (this.values[i][j] !== 0) {\r\n                    const originalCol = j;\r\n                    const originalValue = this.values[i][j];\r\n\r\n                    let k = j;\r\n                    while (k + 1 < this.colCount && this.values[i][k + 1] === 0) {\r\n                        this.values[i][k + 1] = this.values[i][k];\r\n                        this.values[i][k] = 0;\r\n                        k++; moved = true;\r\n                    }\r\n                    if (k + 1 < this.colCount && this.values[i][k + 1] === this.values[i][k]) {\r\n                        const mergedResult = this.values[i][k + 1] * 2;\r\n                        moves.push({\r\n                            fromRow: i,\r\n                            fromCol: originalCol,\r\n                            toRow: i,\r\n                            toCol: k + 1,\r\n                            value: originalValue,\r\n                            merged: true,\r\n                            resultValue: mergedResult\r\n                        });\r\n\r\n                        this.values[i][k + 1] = mergedResult;\r\n                        this.values[i][k] = 0;\r\n                        moved = true;\r\n                        this.node.emit('score', this.values[i][k + 1]);\r\n                    } else {\r\n                        if (k !== originalCol) {\r\n                            moves.push({\r\n                                fromRow: i,\r\n                                fromCol: originalCol,\r\n                                toRow: i,\r\n                                toCol: k,\r\n                                value: originalValue,\r\n                                merged: false\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return { moved, moves };\r\n    }\r\n\r\n    // 生成新格子（animate 表示是否播放生成动画）\r\n    private spawnRandomGrid(animate: boolean = false) {\r\n        const emptyGrids: [number, number][] = [];\r\n        for (let i = 0; i < this.rowCount; i++) {\r\n            for (let j = 0; j < this.colCount; j++) {\r\n                if (this.values[i][j] === 0) {\r\n                    emptyGrids.push([i, j]);\r\n                }\r\n            }\r\n        }\r\n        if (emptyGrids.length === 0) return;\r\n        const [row, col] = emptyGrids[Math.floor(Math.random() * emptyGrids.length)];\r\n        const value = Math.random() < 0.6 ? 2 : 4;\r\n        this.values[row][col] = value;\r\n        if (this.gridData[row][col]) {\r\n            this.gridData[row][col].setValue(value, animate);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 播放平移动画：对 moves 列表中的每一项创建一个临时视觉节点，\r\n     * 将其从 sourcePos 平移到 targetPos，完成后（合并时）播放合并动画，最终刷新底层 grid 显示。\r\n     */\r\n    private playMovesAnimation(moves: Move[]): Promise<void> {\r\n        return new Promise((resolve) => {\r\n            if (!moves || moves.length === 0) {\r\n                // 没有移动直接刷新显示\r\n                this.updateGridViews(false);\r\n                resolve();\r\n                return;\r\n            }\r\n\r\n            const tweens: any[] = [];\r\n            // 在动画期间，暂时把源格子的显示清空（避免重复显示）\r\n            for (const m of moves) {\r\n                const srcGrid = this.gridData[m.fromRow][m.fromCol];\r\n                if (srcGrid) {\r\n                    srcGrid.setValue(0, false); // 立刻清空源格显示（视觉交给临时节点）\r\n                }\r\n            }\r\n\r\n            // 记录完成计数\r\n            let completed = 0;\r\n            const total = moves.length;\r\n\r\n            for (const m of moves) {\r\n                // 计算源和目标的本地坐标（相对于 this.node)\r\n                const srcX = m.fromCol * (this.gridWidth + this.gap) - (this.colCount - 1) * (this.gridWidth + this.gap) / 2;\r\n                const srcY = -m.fromRow * (this.gridHeight + this.gap) + (this.rowCount - 1) * (this.gridHeight + this.gap) / 2;\r\n                const tgtX = m.toCol * (this.gridWidth + this.gap) - (this.colCount - 1) * (this.gridWidth + this.gap) / 2;\r\n                const tgtY = -m.toRow * (this.gridHeight + this.gap) + (this.rowCount - 1) * (this.gridHeight + this.gap) / 2;\r\n\r\n                // 创建一个临时节点（实例化预制体）\r\n                const tempNode = instantiate(this.gridPrefab);\r\n                tempNode.setPosition(srcX, srcY);\r\n                this.node.addChild(tempNode);\r\n\r\n                // 配置大小与文字（使用 Grid 组件来设置显示）\r\n                const gridComp = tempNode.getComponent(Grid);\r\n                if (gridComp) {\r\n                    gridComp.setSize(this.gridWidth, this.gridHeight);\r\n                    // 不要播放生成或合并动画在这里（移动动画独立）\r\n                    gridComp.setValue(m.value, false);\r\n                }\r\n\r\n                // 播放平移动画\r\n                const tw = tween(tempNode)\r\n                    .to(0.5, { position: new Vec3(tgtX, tgtY, 0) }, { easing: 'sineOut' })\r\n                    .call(() => {\r\n                        // 到达目标后：\r\n                        if (m.merged) {\r\n                            // 播放目标格子的合并动画（目标格子是 gridData[toRow][toCol]）\r\n                            const targetGrid = this.gridData[m.toRow][m.toCol];\r\n                            if (targetGrid) {\r\n                                // 先设置目标格子为旧值（动画期间），然后播放合并动画并在最后把新值写回\r\n                                // 注意： values 已经被更新为合并后的值，所以这里直接 playMergeAnimation 然后在最后 refresh\r\n                                targetGrid.playMergeAnimation();\r\n                            }\r\n                        } else {\r\n                            // 非合并：目标格子动画可以是轻微弹动或无（保持简洁）\r\n                        }\r\n                        // 销毁临时节点（移动结束后）\r\n                        tempNode.removeFromParent();\r\n                        completed++;\r\n                        if (completed >= total) {\r\n                            // 所有移动动画完成 -> 刷新底层格子显示（不播放额外动画）\r\n                            this.updateGridViews(false);\r\n                            resolve();\r\n                        }\r\n                    })\r\n                    .start();\r\n\r\n                tweens.push(tw);\r\n            }\r\n\r\n            // 保险：如果 moves.length === 0，上面分支会提前返回\r\n        });\r\n    }\r\n\r\n    // 更新底层 grid 的显示（若 animate 为 true 将调用格子的 setValue(..., true) 播放生成/合并缩放动画）\r\n    private updateGridViews(animate: boolean = false) {\r\n        for (let i = 0; i < this.rowCount; i++) {\r\n            for (let j = 0; j < this.colCount; j++) {\r\n                if (this.gridData[i][j]) {\r\n                    this.gridData[i][j].setValue(this.values[i][j], animate);\r\n                    // 同时确保 grid 节点位置对齐（避免因为 tween 之类遗留问题）\r\n                    const targetX = j * (this.gridWidth + this.gap) - (this.colCount - 1) * (this.gridWidth + this.gap) / 2;\r\n                    const targetY = -i * (this.gridHeight + this.gap) + (this.rowCount - 1) * (this.gridHeight + this.gap) / 2;\r\n                    this.gridData[i][j].node.setPosition(new Vec3(targetX, targetY, 0));\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private CheckGameOver(): boolean {\r\n        if (this.checkHas2048()) return true;\r\n        for (let i = 0; i < this.rowCount; i++) {\r\n            for (let j = 0; j < this.colCount; j++) {\r\n                if (this.values[i][j] == 0) return false;\r\n            }\r\n        }\r\n        for (let i = 0; i < this.rowCount; i++) {\r\n            for (let j = 0; j < this.colCount - 1; j++) {\r\n                if (this.values[i][j] == this.values[i][j + 1]) return false;\r\n            }\r\n        }\r\n        for (let j = 0; j < this.colCount; j++) {\r\n            for (let i = 0; i < this.rowCount - 1; i++) {\r\n                if (this.values[i][j] === this.values[i + 1][j]) return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    private checkHas2048(): boolean {\r\n        for (let i = 0; i < this.rowCount; i++) {\r\n            for (let j = 0; j < this.colCount; j++) {\r\n                if (this.values[i][j] === 2048) return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    update(deltaTime: number) { }\r\n}\r\n"]}